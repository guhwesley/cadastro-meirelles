<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Vendas</title>
  
  <!-- Font Awesome para √≠cones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- html2canvas para gerar imagem do comprovante -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0a3d62, #1e90ff);
      padding: 20px;
      color: #fff;
    }

    h1, h2 { text-align:center; }

    .box {
      background: #ffffff;
      color: #333;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    label { display:block; margin-top:10px; font-weight:600; }

    input, select {
      width:100%;
      padding:10px;
      margin-top:4px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th { background:#1e90ff; color:white; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }

    button {
      padding:10px 16px;
      margin-top:10px;
      cursor:pointer;
      border:none;
      border-radius:6px;
      background:#1e90ff;
      color:white;
      font-weight:bold;
    }

    button:hover { background:#0a3d62; }

    .total { font-size:20px; font-weight:bold; text-align:right; }

    .logo-area { text-align:center; margin-bottom:20px; }
    .logo-area img { max-height:120px; margin-top:10px; }

    /* Estilo do comprovante */
    .comprovante {
      padding:20px;
      background:#fff;
      color:#000;
      font-family: Arial, sans-serif;
      width:400px;
      margin:0 auto;
      border:1px solid #ccc;
      border-radius:10px;
    }

    .empresa-nome {
      font-size:18px;
      font-weight:bold;
      color:#1e90ff;
      margin:5px 0;
    }

    .empresa-contato i {
      margin-right:5px;
    }

    .empresa-contato .instagram { color:#E1306C; }
    .empresa-contato .whatsapp { color:#25D366; }
    .empresa-contato .email { color:#EA4335; }

    h3 { color:#1e90ff; margin-bottom:10px; }
  </style>
</head>
<body>

<h1>üì¶ Cadastro de Vendas</h1>

<div class="logo-area box">
  <img src="https://i.postimg.cc/15q9V4g3/590410744-17857518639567477-1261351053422766599-n.jpg" alt="Logo da Empresa" style="max-height:200px; margin:10px auto; display:block;" />
</div>

<div class="box">
  <h2>Cliente</h2>

  <label>Nome <input id="nome" /></label>
  <label>CPF <input id="cpf" /></label>
  <label>Telefone <input id="telefone" /></label>
  <label>Onde trabalha <input id="trabalho" /></label>
  <label>CEP <input id="cep" /></label>
  <label>Rua <input id="rua" /></label>
  <label>Bairro <input id="bairro" /></label>
  <label>Cidade <input id="cidade" /></label>
  <label>Endere√ßo (N√∫mero / Complemento) <input id="endereco" /></label>
</div>

<div class="box">
  <h2>Produtos</h2>

  <label>Produto
    <select id="produto">
      <option value="" data-preco="0">Selecione</option>
      <option data-preco="400">Cobredom - R$400</option>
      <option data-preco="300">Colcha Casal - R$300</option>
      <option data-preco="350">Colcha Queen - R$350</option>
      <option data-preco="300">Jogo Len√ßol Casal - R$300</option>
      <option data-preco="350">Jogo Len√ßol Queen - R$350</option>
      <option data-preco="270">Len√ßol Solteiro - R$270</option>
      <option data-preco="200">Kit Manta Infantil - R$200</option>
      <option data-preco="180">Manta Que Brilha - R$180</option>
      <option data-preco="100">Travesseiro - R$100</option>
      <option data-preco="180">Frigideira 3 Pe√ßas - R$180</option>
      <option data-preco="350">Frigideira Grande - R$350</option>
      <option data-preco="180">Frigideira Grill - R$180</option>
      <option data-preco="500">Jogo de Panela - R$500</option>
      <option data-preco="400">Kit Cozinha Cinzal - R$400</option>
      <option data-preco="300">Kit Cozinha J Serrano - R$300</option>
      <option data-preco="450">Panela de Press√£o - R$450</option>
      <option data-preco="350">Panel√£o - R$350</option>
      <option data-preco="50">Pote de Vidro - R$50</option>
      <option data-preco="150">Jogo de Potes - R$150</option>
      <option data-preco="180">Cortina Cozinha - R$180</option>
      <option data-preco="120">Tapete Entrada - R$120</option>
      <option data-preco="350">Tapete Sala Peludo - R$350</option>
      <option data-preco="450">Tapete Veludo - R$450</option>
      <option data-preco="400">Tapete Estampado - R$400</option>
      <option data-preco="550">Ba√∫ - R$550</option>
      <option data-preco="500">Cadeira Balan√ßo - R$500</option>
      <option data-preco="350">Cadeira Fixa - R$350</option>
      <option data-preco="250">Mesinha - R$250</option>
      <option data-preco="400">Sapateira - R$400</option>
      <option data-preco="200">Jogo Banheiro - R$200</option>
      <option data-preco="180">Cesto de Roupas - R$180</option>
      <option data-preco="400">Espelho - R$400</option>
    </select>
  </label>

  <label>Quantidade <input id="quantidade" type="number" value="1" min="1" /></label>
  <button onclick="adicionarProduto()">Adicionar Produto</button>

  <table>
    <thead>
      <tr>
        <th>Produto</th>
        <th>Qtd</th>
        <th>Pre√ßo</th>
        <th>Total</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>

  <p class="total">Entrada: R$ <span id="entradaResumo">0.00</span></p>
  <p class="total">Valor Total: R$ <span id="valorTotal">0.00</span></p>
  <p class="total">Parcelamento: <span id="valorParcelas">1x de R$ 0.00</span></p>
</div>

<div class="box">
  <h2>Pagamento</h2>
 <label>Entrada <input id="entrada" type="number" value="0" /></label>

<label>Forma de Pagamento
  <select id="forma">
    <option value="avista">√Ä vista</option>
    <option value="parcelado">Parcelado</option>
    <option value="pix">Pix</option>
    <option value="cartao">Cart√£o</option>
  </select>
</label>

<label>Parcelas <input id="parcelas" type="number" value="1" /></label>

<label>Data do Vencimento <input id="vencimento" type="date" /></label>
</div>

<div class="box" style="text-align:center;">
  <button id="btnEnviar" onclick="enviarWebhook()">üì§ Enviar para o Sistema</button>
 <button id="btnComprovante" onclick="imprimirComprovante()" disabled>
üìÑ Compartilhar / Imprimir
</button>

<button id="btnNovaVenda" onclick="novaVenda()">
  üÜï Nova Venda
</button>

</div>

<script>
let total = 0;
const WEBHOOK_URL ="https://n8n.vps6993.panel.icontainer.net/webhook/MEIRELLES-CADASTRO";
function $(id){ return document.getElementById(id); }
let enviadoSistema = false;
let enviandoAgora = false;	

function adicionarProduto(){
  const select = $('produto');
  const nome = select.options[select.selectedIndex].text;
  const preco = Number(select.options[select.selectedIndex].dataset.preco);
  const qtd = Number($('quantidade').value);
  if(!preco) return alert('Selecione um produto');
  const subtotal = preco * qtd;
  total += subtotal;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${nome}</td>
    <td>${qtd}</td>
    <td>R$ ${preco}</td>
    <td>R$ ${subtotal}</td>
    <td><button onclick="remover(this, ${subtotal})">X</button></td>
  `;
  $('lista').appendChild(tr);
  atualizarTotal();
  $('quantidade').value = 1;
  select.selectedIndex = 0;
}

function remover(btn, valor){
  total -= valor;
  btn.parentElement.parentElement.remove();
  atualizarTotal();
}

function atualizarTotal(){
  const entrada = Number($('entrada').value || 0);
  let parcelas = Number($('parcelas').value || 1);
  if(parcelas < 1) parcelas = 1;
  let liquido = total - entrada;
  if(liquido < 0) liquido = 0;

  // C√°lculo de desconto √† vista
  let descontoAvista = 0;
  if($('forma').value === 'avista'){
    descontoAvista = liquido * 0.10; // 10% de desconto
  }
  const valorComDesconto = liquido - descontoAvista;

  const valorParcela = valorComDesconto / parcelas;

  // Mostrar desconto na tela apenas se houver
  if(descontoAvista > 0){
    if(!$('desconto')){ 
      const p = document.createElement('p');
      p.className = 'total';
      p.id = 'desconto';
      p.style.color = '#FFD700'; // dourado
      p.style.textAlign = 'right';
      $('valorTotal').parentElement.before(p);
    }
    $('desconto').innerText = `Desconto √† vista: R$ ${descontoAvista.toFixed(2)}`;
  } else if($('desconto')){
    $('desconto').remove();
  }

  $('valorTotal').innerText = valorComDesconto.toFixed(2);
  $('entradaResumo').innerText = entrada.toFixed(2);
  $('valorParcelas').innerText = `${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
}

$('entrada').addEventListener('input', atualizarTotal);
$('parcelas').addEventListener('input', atualizarTotal);
$('produto').addEventListener('change', atualizarTotal);
$('quantidade').addEventListener('input', atualizarTotal);
$('forma').addEventListener('change', atualizarTotal);

function enviarWebhook(){

// üõë CAMPOS OBRIGAT√ìRIOS
const obrigatorios = [
  'nome',
  'cpf',
  'telefone',
  'cep',
  'rua',
  'bairro',
  'cidade',
  'endereco'
];

for (let id of obrigatorios) {
  const campo = $(id);

  if (!campo.value.trim()) {
    alert(`Preencha o campo: ${campo.previousElementSibling?.innerText || id}`);
    campo.focus();
    return;
  }
}


if (enviandoAgora) {	
  alert('Aguarde, envio em andamento...');
  return;
}

  // üß± TRAVA: n√£o deixa enviar duas vezes
  if (enviadoSistema) {
    alert('Esta venda j√° foi enviada.');
    return;
  }

// üõë TRAVA: exige ao menos 1 produto
  if (!document.querySelector('#lista tr')) {
    alert('Adicione ao menos um produto.');
    return;

  }

if (!$('vencimento').value) {
  alert('Informe a data de vencimento.');
  return;
}

  const itens = [];
  document.querySelectorAll('#lista tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    itens.push({
      produto: tds[0].innerText,
      quantidade: Number(tds[1].innerText),
      preco: Number(tds[2].innerText.replace('R$','').trim()),
      total: Number(tds[3].innerText.replace('R$','').trim())
    });
  });

  let parcelasQtd = Number($('parcelas').value || 1);
if (parcelasQtd < 1) parcelasQtd = 1;
   const dia = $('vencimento').value;
  const valorLiquido = Number($('valorTotal').innerText);
  const valorParcela = valorLiquido / parcelasQtd;

 const parcelasArray = [];
const base = new Date(dia);

for (let i = 0; i < parcelasQtd; i++) {
  const d = new Date(base);
  d.setMonth(d.getMonth() + i);
  parcelasArray.push({
    numero: i + 1,
    valor: valorParcela.toFixed(2),
    vencimento: d.toISOString().split('T')[0]
  });
  }

  const payload = {
    nome: $('nome').value,
    cpf: $('cpf').value,
    telefone: $('telefone').value,
    trabalho: $('trabalho').value,
    cep: $('cep').value,
    rua: $('rua').value,
    bairro: $('bairro').value,
    cidade: $('cidade').value,
    endereco: $('endereco').value,
    itens,
    valor_total: valorLiquido,
    entrada: Number($('entrada').value),
    parcelas: parcelasQtd,
    vencimento: dia,
    forma_pagamento: $('forma').value,
    status: valorLiquido === 0 ? 'pago' : 'pendente',
    parcelamento: parcelasArray
  };
  const btn = document.getElementById('btnEnviar');
  btn.disabled = true;
  enviandoAgora = true;

  fetch(WEBHOOK_URL,{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify(payload)
})
.then(res => {
  if (!res.ok) throw new Error('Falha no envio');
  return res.text();
})
.then(() => {
  enviadoSistema = true;
  enviandoAgora = false; 
  alert('Venda enviada com sucesso!');
  document.getElementById('btnComprovante').disabled = false;
  document.getElementById('btnEnviar').disabled = true;
})

.catch(e => {
  enviandoAgora = false;
  btn.disabled = false;
  alert('Erro: ' + e.message);
});
}

// Fun√ß√£o de comprovante com logo grande e cores
function imprimirComprovante(){
 if(!enviadoSistema){
    alert('Envie a venda antes de imprimir o comprovante.');
    return;
  }
    const comprovanteDiv = document.createElement('div');
    comprovanteDiv.className = "comprovante";

    // Informa√ß√µes da empresa sem logo, mais compactas e no topo
    const empresaHTML = `
    <div style="text-align:center; margin-bottom:10px;">
        <div class="empresa-nome" style="font-size:18px; font-weight:bold; color:#1e90ff;">Crediario Meirelles</div>
        <div class="empresa-contato" style="font-size:14px; line-height:1.4;">
            <i class="fab fa-instagram instagram"></i> @crediariomeirelles<br/>
            <i class="fab fa-whatsapp whatsapp"></i> (48) 98833-7779<br/>
            <i class="fas fa-envelope email"></i> meirellespatrick99@gmail.com
        </div>
    </div>
    <h3 style="text-align:left; color:#1e90ff; margin-bottom:10px;">RECIBO DE VENDA</h3>
    `;

    const clienteHTML = `
      <p><strong>Nome:</strong> ${$('nome').value}</p>
      <p><strong>CPF:</strong> ${$('cpf').value}</p>
      <p><strong>Telefone:</strong> ${$('telefone').value}</p>
      <p><strong>Endere√ßo:</strong> ${$('rua').value} ${$('endereco').value} - ${$('bairro').value}, ${$('cidade').value}</p>
    `;

    let itensHTML = '';
    document.querySelectorAll('#lista tr').forEach(tr=>{
        const t = tr.querySelectorAll('td');
        itensHTML += `<tr>
                        <td>${t[0].innerText}</td>
                        <td>${t[1].innerText}</td>
                        <td>${t[2].innerText}</td>
                        <td>${t[3].innerText}</td>
                      </tr>`;
    });

    const produtosHTML = `
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr style="background:#1e90ff; color:#fff;">
            <th>Produto</th>
            <th>Qtd</th>
            <th>Valor Unit√°rio</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>${itensHTML}</tbody>
      </table>
    `;

    const resumoHTML = `
      <p style="text-align:right; margin-top:5px;"><strong>Entrada:</strong> R$ ${$('entrada').value}</p>
      ${$('desconto') ? `<p style="text-align:right; color:#FFD700;"><strong>${$('desconto').innerText}</strong></p>` : ''}
      <p style="text-align:right;"><strong>Total:</strong> R$ ${$('valorTotal').innerText}</p>
      <p style="text-align:right;"><strong>Parcelamento:</strong> ${$('parcelas').value}x de R$ ${(Number($('valorTotal').innerText)/(Number($('parcelas').value) || 1)).toFixed(2)}
</p>
      <p style="text-align:right;"><strong>Vencimento:</strong> ${$('vencimento').value}</p>
      <p style="text-align:right;"><strong>Forma de Pagamento:</strong> ${$('forma').options[$('forma').selectedIndex].text}</p>
      <p style="text-align:center; font-style:italic; margin-top:10px;">Obrigado pela prefer√™ncia!</p>
    `;

    comprovanteDiv.innerHTML = empresaHTML + clienteHTML + produtosHTML + resumoHTML;
    document.body.appendChild(comprovanteDiv);

    html2canvas(comprovanteDiv).then(canvas=>{
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'comprovante.png';
        link.click();
        document.body.removeChild(comprovanteDiv);
    });
}

/* ===== CEP AUTOM√ÅTICO ===== */
$('cep').addEventListener('blur', function () {
  const cep = this.value.replace(/\D/g, '');
  if (cep.length !== 8) return;

  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(response => response.json())
    .then(dados => {
      if (dados.erro) {
        alert('CEP n√£o encontrado');
        return;
      }
      $('rua').value = dados.logradouro || '';
      $('bairro').value = dados.bairro || '';
      $('cidade').value = dados.localidade || '';
    })
    .catch(() => alert('Erro ao buscar o CEP'));
});

function novaVenda(){

  if(!confirm('Deseja iniciar uma nova venda?')) return;

  // Limpa campos do cliente
  ['nome','cpf','telefone','trabalho','cep','rua','bairro','cidade','endereco'].forEach(id=>{
    $(id).value = '';
  });

  // Limpa produtos
  document.getElementById('lista').innerHTML = '';
  total = 0;

  // Reseta pagamento
  $('entrada').value = 0;
  $('parcelas').value = 1;
  $('forma').value = 'avista';
  $('vencimento').value = '';

  // Remove desconto se existir
  if($('desconto')) $('desconto').remove();

  // Zera totais
  $('valorTotal').innerText = '0.00';
  $('entradaResumo').innerText = '0.00';
  $('valorParcelas').innerText = '1x de R$ 0.00';

  // Reseta flags
  enviadoSistema = false;
  enviandoAgora = false;

  // Bot√µes
  document.getElementById('btnComprovante').disabled = true;
  document.getElementById('btnEnviar').disabled = false;

  alert('Nova venda iniciada ‚úÖ');
  $('nome').focus();
}

</script>

</body>
</html>
