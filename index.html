<!DOCTYPE html>
<html lang="pt-BR">
<head>


  <meta charset="UTF-8" />
  <title>Cadastro de Vendas</title>
  <style>
@media print {

  body {
    margin: 0;
    padding: 0;
    background: white;
  }

  /* s√≥ imprime o comprovante */
  body * {
    visibility: hidden;
  }

  #resumoPrint, #resumoPrint * {
    visibility: visible;
  }

  #resumoPrint {
    position: absolute;
    left: 0;
    top: 0;
    width: 210mm;
    padding: 15mm;
    box-sizing: border-box;
  }

  /* impede quebra */
  table, tr, td, th {
    page-break-inside: avoid;
  }

  #printArea {
    page-break-after: avoid;
    page-break-before: avoid;
  }
}

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0a3d62, #1e90ff);
      padding: 20px;
      color: #fff;
    }

    h1, h2 { text-align:center; }

    .box {
      background: #ffffff;
      color: #333;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    label { display:block; margin-top:10px; font-weight:600; }

    input, select {
      width:100%;
      padding:10px;
      margin-top:4px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th { background:#1e90ff; color:white; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }

    button {
      padding:10px 16px;
      margin-top:10px;
      cursor:pointer;
      border:none;
      border-radius:6px;
      background:#1e90ff;
      color:white;
      font-weight:bold;
    }

    button:hover { background:#0a3d62; }

    .total { font-size:20px; font-weight:bold; text-align:right; }

    .logo-area { text-align:center; margin-bottom:20px; }
    .logo-area img { max-height:120px; margin-top:10px; }

   
    
  </style>
</head>
<body>

<h1>üì¶ Cadastro de Vendas</h1>

<div class="logo-area box">
  <img src="https://i.postimg.cc/15q9V4g3/590410744-17857518639567477-1261351053422766599-n.jpg" alt="Logo da Empresa" style="max-height:140px; margin:10px auto; display:block;" />
</div>

<div class="box">
  <h2>Cliente</h2>

  <label>Nome <input id="nome" /></label>
  <label>CPF <input id="cpf" /></label>
  <label>Telefone <input id="telefone" /></label>

  <label>Onde trabalha <input id="trabalho" /></label>

  <label>CEP <input id="cep" /></label>
  <label>Rua <input id="rua" /></label>
  <label>Bairro <input id="bairro" /></label>
  <label>Cidade <input id="cidade" /></label>

  <label>Endere√ßo (N√∫mero / Complemento) <input id="endereco" /></label>
</div>

<div class="box">
  <h2>Produtos</h2>

  <label>Produto
    <select id="produto">
      <option value="" data-preco="0">Selecione</option>
      <option data-preco="400">Cobredom - R$400</option>
      <option data-preco="300">Colcha Casal - R$300</option>
      <option data-preco="350">Colcha Queen - R$350</option>
      <option data-preco="300">Jogo Len√ßol Casal - R$300</option>
      <option data-preco="350">Jogo Len√ßol Queen - R$350</option>
      <option data-preco="270">Len√ßol Solteiro - R$270</option>
      <option data-preco="200">Kit Manta Infantil - R$200</option>
      <option data-preco="180">Manta Que Brilha - R$180</option>
      <option data-preco="100">Travesseiro - R$100</option>
      <option data-preco="180">Frigideira 3 Pe√ßas - R$180</option>
      <option data-preco="350">Frigideira Grande - R$350</option>
      <option data-preco="180">Frigideira Grill - R$180</option>
      <option data-preco="500">Jogo de Panela - R$500</option>
      <option data-preco="400">Kit Cozinha Cinzal - R$400</option>
      <option data-preco="300">Kit Cozinha J Serrano - R$300</option>
      <option data-preco="450">Panela de Press√£o - R$450</option>
      <option data-preco="350">Panel√£o - R$350</option>
      <option data-preco="50">Pote de Vidro - R$50</option>
      <option data-preco="150">Jogo de Potes - R$150</option>
      <option data-preco="180">Cortina Cozinha - R$180</option>
      <option data-preco="120">Tapete Entrada - R$120</option>
      <option data-preco="350">Tapete Sala Peludo - R$350</option>
      <option data-preco="450">Tapete Veludo - R$450</option>
      <option data-preco="400">Tapete Estampado - R$400</option>
      <option data-preco="550">Ba√∫ - R$550</option>
      <option data-preco="500">Cadeira Balan√ßo - R$500</option>
      <option data-preco="350">Cadeira Fixa - R$350</option>
      <option data-preco="250">Mesinha - R$250</option>
      <option data-preco="400">Sapateira - R$400</option>
      <option data-preco="200">Jogo Banheiro - R$200</option>
      <option data-preco="180">Cesto de Roupas - R$180</option>
      <option data-preco="400">Espelho - R$400</option>
    </select>
  </label>

  <label>Quantidade
    <input id="quantidade" type="number" value="1" min="1" />
  </label>

  <button onclick="adicionarProduto()">Adicionar Produto</button>

  <table>
    <thead>
      <tr>
        <th>Produto</th>
        <th>Qtd</th>
        <th>Pre√ßo</th>
        <th>Total</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  
</table>

<p class="total">Entrada: R$ <span id="entradaResumo">0.00</span></p>
<p class="total">Valor Total: R$ <span id="valorTotal">0.00</span></p>
<p class="total">Parcelamento: <span id="valorParcelas">1x de R$ 0.00</span></p>
</div>

<div class="box">
  <h2>Pagamento</h2>
  <label>Entrada <input id="entrada" type="number" value="0" /></label>
  <label>Parcelas <input id="parcelas" type="number" value="1" /></label>
  <label>Dia do Vencimento
  <input id="vencimento" type="number" min="1" max="31" placeholder="Ex: 25" />
</label>
  <label>Forma de Pagamento
    <select id="forma">
      <option value="avista">√Ä vista</option>
      <option value="parcelado">Parcelado</option>
      <option value="pix">Pix</option>
      <option value="cartao">Cart√£o</option>
    </select>
  </label>
</div>

<div class="box" style="text-align:center;">
  <button onclick="enviarWebhook()">üì§ Enviar para o Sistema</button>
  <button onclick="imprimirComprovante()">üñ®Ô∏è Imprimir Comprovante</button>

</div>

<div id="resumoPrint" style="background:white;color:black;padding:20px;display:none"></div>

<script>
let total = 0;

const WEBHOOK_URL = "https://n8n.vps6993.panel.icontainer.net/webhook/MEIRELLES";
function $(id){
  return document.getElementById(id);
}

function adicionarProduto(){
  const select = document.getElementById('produto');
  const nome = select.options[select.selectedIndex].text;
  const preco = Number(select.options[select.selectedIndex].dataset.preco);
  const qtd = Number(document.getElementById('quantidade').value);

  if(!preco) return alert('Selecione um produto');

  const subtotal = preco * qtd;
  total += subtotal;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${nome}</td>
    <td>${qtd}</td>
    <td>R$ ${preco}</td>
    <td>R$ ${subtotal}</td>
    <td><button onclick="remover(this, ${subtotal})">X</button></td>
  `;

  document.getElementById('lista').appendChild(tr);
  atualizarTotal();

  document.getElementById('quantidade').value = 1;
  document.getElementById('produto').selectedIndex = 0;
}

function remover(btn, valor){
  total -= valor;
  btn.parentElement.parentElement.remove();
  atualizarTotal();
}

function atualizarTotal(){
  const entrada = Number(document.getElementById('entrada').value || 0);
  let parcelas = Number(document.getElementById('parcelas').value || 1);

  if(parcelas < 1) parcelas = 1;

  let liquido = total - entrada;
  if(liquido < 0) liquido = 0;

  const valorParcela = liquido / parcelas;

  document.getElementById('valorTotal').innerText = liquido.toFixed(2);
  document.getElementById('entradaResumo').innerText = entrada.toFixed(2);
  document.getElementById('valorParcelas').innerText =
    `${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
}

document.getElementById('entrada').addEventListener('input', atualizarTotal);
document.getElementById('parcelas').addEventListener('input', atualizarTotal);
document.getElementById('produto').addEventListener('change', atualizarTotal);
document.getElementById('quantidade').addEventListener('input', atualizarTotal);

function enviarWebhook(){
  const itens = [];

  document.querySelectorAll('#lista tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    itens.push({
      produto: tds[0].innerText,
      quantidade: Number(tds[1].innerText),
      preco: Number(tds[2].innerText.replace('R$','')),
      total: Number(tds[3].innerText.replace('R$',''))
    });
  });

  const parcelasQtd = Number(document.getElementById('parcelas').value || 1);
  const dia = Number(document.getElementById('vencimento').value || 1);
  const valorLiquido = Number(document.getElementById('valorTotal').innerText);
  const valorParcela = valorLiquido / parcelasQtd;

  const parcelasArray = [];
  const hoje = new Date();

  for (let i = 0; i < parcelasQtd; i++) {
    const d = new Date(hoje);
    d.setMonth(d.getMonth() + i + 1);
    d.setDate(dia);

    parcelasArray.push({
      numero: i + 1,
      valor: valorParcela.toFixed(2),
      vencimento: d.toISOString().split('T')[0]
    });
  }

 const payload = {
  nome: $('nome').value,
  cpf: $('cpf').value,
  telefone: $('telefone').value,

  trabalho: $('trabalho').value,
  cep: $('cep').value,
  rua: $('rua').value,
  bairro: $('bairro').value,
  cidade: $('cidade').value,

  endereco: $('endereco').value,
  itens,
  valor_total: valorLiquido,
  entrada: Number($('entrada').value),
  parcelas: parcelasQtd,
  vencimento: dia,
  forma_pagamento: $('forma').value,
  status: valorLiquido === 0 ? 'pago' : 'pendente',
  parcelamento: parcelasArray
};


  fetch(WEBHOOK_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  })
  .then(()=>alert('Venda enviada com sucesso!'))
  .catch(e=>alert('Erro: '+e));
}




function imprimirComprovante() {

  const resumo = document.getElementById('resumoPrint');
  resumo.style.display = 'block';

  let itensHTML = '';
  document.querySelectorAll('#lista tr').forEach(tr => {
    const t = tr.querySelectorAll('td');
    itensHTML += `
      <tr>
        <td>${t[0].innerText}</td>
        <td style="text-align:center;">${t[1].innerText}</td>
        <td style="text-align:right;">${t[2].innerText}</td>
        <td style="text-align:right;">${t[3].innerText}</td>
      </tr>
    `;
  });

  resumo.innerHTML = `
 <div id="printArea">

  <!-- CABE√áALHO -->
  <div style="
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#1e40af;
    color:white;
    padding:15px;
    border-radius:6px;
  ">
    <img src="https://i.postimg.cc/15q9V4g3/590410744-17857518639567477-1261351053422766599-n.jpg" style="height:70px">
    <div style="text-align:right;font-size:13px">
      <div>Comprovante de Venda</div>
      <div>${new Date().toLocaleDateString()}</div>
    </div>
  </div>

  <h2 style="text-align:center;margin:8px 0">RECIBO</h2>

  <!-- CLIENTE -->
  <p style="font-size:13px;margin:4px 0"><strong>Cliente:</strong> ${$('nome').value}</p>
  <p style="font-size:13px;margin:4px 0"><strong>CPF:</strong> ${$('cpf').value}</p>
  <p style="font-size:13px;margin:4px 0"><strong>Telefone:</strong> ${$('telefone').value}</p>
  <p style="font-size:13px;margin:4px 0"><strong>Endere√ßo:</strong> ${$('endereco').value}</p>

  <!-- PRODUTOS -->
  <table style="width:100%;border-collapse:collapse;margin-top:10px;font-size:13px">
    <thead>
      <tr style="background:#1e40af;color:white">
        <th>Produto</th>
        <th>Qtd</th>
        <th>Valor</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      ${itensHTML}
    </tbody>
  </table>

  <!-- RESUMO -->
  <div style="margin-top:10px">
    <p style="font-size:13px;margin:4px 0"><strong>Entrada:</strong> R$ ${$('entrada').value}</p>
    <p style="font-size:13px;margin:4px 0"><strong>Parcelas:</strong> ${$('parcelas').value}</p>
    <p style="font-size:13px;margin:4px 0"><strong>Vencimento:</strong> Dia ${$('vencimento').value}</p>
    <p style="font-size:13px;margin:4px 0"><strong>Forma:</strong> ${$('forma').value}</p>

    <h2 style="text-align:right;margin-top:8px">
      Total: R$ ${document.getElementById('valorTotal').innerText}
    </h2>
  </div>

  <p style="text-align:center;margin-top:20px;font-style:italic;font-size:13px">
    Obrigado pela prefer√™ncia!
  </p>

</div>
  `;

  // imprime
  window.print();

  // esconde novamente ap√≥s imprimir
  setTimeout(() => {
    resumo.style.display = 'none';
  }, 500);
}


/* ===== CEP AUTOM√ÅTICO ===== */
document.getElementById('cep').addEventListener('blur', function () {
  const cep = this.value.replace(/\D/g, '');

  if (cep.length !== 8) return;
  

  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(response => response.json())
    .then(dados => {
      if (dados.erro) {
        alert('CEP n√£o encontrado');
        return;
      }

      document.getElementById('rua').value = dados.logradouro || '';
      document.getElementById('bairro').value = dados.bairro || '';
      document.getElementById('cidade').value = dados.localidade || '';
    })
    .catch(() => alert('Erro ao buscar o CEP'));
});
</script>

</body>
</html>
