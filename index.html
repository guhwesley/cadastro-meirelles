<!DOCTYPE html>
<html lang="pt-BR">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <meta charset="UTF-8" />
  <title>Cadastro de Vendas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0a3d62, #1e90ff);
      padding: 20px;
      color: #fff;
    }

    h1, h2 { text-align:center; }

    .box {
      background: #ffffff;
      color: #333;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    label { display:block; margin-top:10px; font-weight:600; }

    input, select {
      width:100%;
      padding:10px;
      margin-top:4px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th { background:#1e90ff; color:white; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }

    button {
      padding:10px 16px;
      margin-top:10px;
      cursor:pointer;
      border:none;
      border-radius:6px;
      background:#1e90ff;
      color:white;
      font-weight:bold;
    }

    button:hover { background:#0a3d62; }

    .total { font-size:20px; font-weight:bold; text-align:right; }

    .logo-area { text-align:center; margin-bottom:20px; }
    .logo-area img { max-height:120px; margin-top:10px; }

    @media print {
      body { background:white; color:black; }
      button, input, select { display:none; }
      .box { box-shadow:none; }
    }
  </style>
</head>
<body>

<h1>üì¶ Cadastro de Vendas</h1>

<div class="logo-area box">
  <img src="https://i.postimg.cc/15q9V4g3/590410744-17857518639567477-1261351053422766599-n.jpg" alt="Logo da Empresa" style="max-height:140px; margin:10px auto; display:block;" />
</div>

<div class="box">
  <h2>Cliente</h2>
  <label>Nome <input id="nome" /></label>
  <label>CPF <input id="cpf" /></label>
  <label>Telefone <input id="telefone" /></label>
  <label>Endere√ßo <input id="endereco" /></label>
</div>

<div class="box">
  <h2>Produtos</h2>

  <label>Produto
    <select id="produto">
      <option value="" data-preco="0">Selecione</option>
      <option data-preco="400">Cobredom - R$400</option>
      <option data-preco="300">Colcha Casal - R$300</option>
      <option data-preco="350">Colcha Queen - R$350</option>
      <option data-preco="300">Jogo Len√ßol Casal - R$300</option>
      <option data-preco="350">Jogo Len√ßol Queen - R$350</option>
      <option data-preco="270">Len√ßol Solteiro - R$270</option>
      <option data-preco="200">Kit Manta Infantil - R$200</option>
      <option data-preco="180">Manta Que Brilha - R$180</option>
      <option data-preco="100">Travesseiro - R$100</option>
      <option data-preco="180">Frigideira 3 Pe√ßas - R$180</option>
      <option data-preco="350">Frigideira Grande - R$350</option>
      <option data-preco="180">Frigideira Grill - R$180</option>
      <option data-preco="500">Jogo de Panela - R$500</option>
      <option data-preco="400">Kit Cozinha Cinzal - R$400</option>
      <option data-preco="300">Kit Cozinha J Serrano - R$300</option>
      <option data-preco="450">Panela de Press√£o - R$450</option>
      <option data-preco="350">Panel√£o - R$350</option>
      <option data-preco="50">Pote de Vidro - R$50</option>
      <option data-preco="150">Jogo de Potes - R$150</option>
      <option data-preco="180">Cortina Cozinha - R$180</option>
      <option data-preco="120">Tapete Entrada - R$120</option>
      <option data-preco="350">Tapete Sala Peludo - R$350</option>
      <option data-preco="450">Tapete Veludo - R$450</option>
      <option data-preco="400">Tapete Estampado - R$400</option>
      <option data-preco="550">Ba√∫ - R$550</option>
      <option data-preco="500">Cadeira Balan√ßo - R$500</option>
      <option data-preco="350">Cadeira Fixa - R$350</option>
      <option data-preco="250">Mesinha - R$250</option>
      <option data-preco="400">Sapateira - R$400</option>
      <option data-preco="200">Jogo Banheiro - R$200</option>
      <option data-preco="180">Cesto de Roupas - R$180</option>
      <option data-preco="400">Espelho - R$400</option>
    </select>
  </label>

  <label>Quantidade
    <input id="quantidade" type="number" value="1" min="1" />
  </label>

  <button onclick="adicionarProduto()">Adicionar Produto</button>

  <table>
    <thead>
      <tr>
        <th>Produto</th>
        <th>Qtd</th>
        <th>Pre√ßo</th>
        <th>Total</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  
</table>

<p class="total">Entrada: R$ <span id="entradaResumo">0.00</span></p>
<p class="total">Valor Total: R$ <span id="valorTotal">0.00</span></p>
<p class="total">Parcelamento: <span id="valorParcelas">1x de R$ 0.00</span></p>
</div>

<div class="box">
  <h2>Pagamento</h2>
  <label>Entrada <input id="entrada" type="number" value="0" /></label>
  <label>Parcelas <input id="parcelas" type="number" value="1" /></label>
  <label>Dia do Vencimento
  <input id="vencimento" type="number" min="1" max="31" placeholder="Ex: 25" />
</label>
  <label>Forma de Pagamento
    <select id="forma">
      <option value="avista">√Ä vista</option>
      <option value="parcelado">Parcelado</option>
      <option value="pix">Pix</option>
      <option value="cartao">Cart√£o</option>
    </select>
  </label>
</div>

<div class="box" style="text-align:center;">
  <button onclick="enviarWebhook()">üì§ Enviar para o Sistema</button>
  <button onclick="gerarPDF()">üìÑ Gerar PDF</button>
</div>

<div id="resumoPrint" style="background:white;color:black;padding:20px;display:none"></div>

<script>
let total = 0;

const WEBHOOK_URL = "https://n8n.vps6993.panel.icontainer.net/webhook/MEIRELLES";

function adicionarProduto(){
  const select = document.getElementById('produto');
  const nome = select.options[select.selectedIndex].text;
  const preco = Number(select.options[select.selectedIndex].dataset.preco);
  const qtd = Number(document.getElementById('quantidade').value);

  if(!preco) return alert('Selecione um produto');

  const subtotal = preco * qtd;
  total += subtotal;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${nome}</td>
    <td>${qtd}</td>
    <td>R$ ${preco}</td>
    <td>R$ ${subtotal}</td>
    <td><button onclick="remover(this, ${subtotal})">X</button></td>
  `;

  document.getElementById('lista').appendChild(tr);
  atualizarTotal();

  document.getElementById('quantidade').value = 1;
  document.getElementById('produto').selectedIndex = 0;
}

function remover(btn, valor){
  total -= valor;
  btn.parentElement.parentElement.remove();
  atualizarTotal();
}

function atualizarTotal(){
  const entrada = Number(document.getElementById('entrada').value || 0);
  let parcelas = Number(document.getElementById('parcelas').value || 1);

  if(parcelas < 1) parcelas = 1;

  let liquido = total - entrada;
  if(liquido < 0) liquido = 0;

  const valorParcela = liquido / parcelas;

  document.getElementById('valorTotal').innerText = liquido.toFixed(2);
  document.getElementById('entradaResumo').innerText = entrada.toFixed(2);
  document.getElementById('valorParcelas').innerText =
    `${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
}

document.getElementById('entrada').addEventListener('input', atualizarTotal);
document.getElementById('parcelas').addEventListener('input', atualizarTotal);
document.getElementById('produto').addEventListener('change', atualizarTotal);
document.getElementById('quantidade').addEventListener('input', atualizarTotal);

function enviarWebhook(){
  const itens = [];

  document.querySelectorAll('#lista tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    itens.push({
      produto: tds[0].innerText,
      quantidade: Number(tds[1].innerText),
      preco: Number(tds[2].innerText.replace('R$','')),
      total: Number(tds[3].innerText.replace('R$',''))
    });
  });

  const parcelasQtd = Number(document.getElementById('parcelas').value || 1);
  const dia = Number(document.getElementById('vencimento').value || 1);
  const valorLiquido = Number(document.getElementById('valorTotal').innerText);
  const valorParcela = valorLiquido / parcelasQtd;

  const parcelasArray = [];
  const hoje = new Date();

  for (let i = 0; i < parcelasQtd; i++) {
    const d = new Date(hoje);
    d.setMonth(d.getMonth() + i + 1);
    d.setDate(dia);

    parcelasArray.push({
      numero: i + 1,
      valor: valorParcela.toFixed(2),
      vencimento: d.toISOString().split('T')[0]
    });
  }

  const payload = {
    nome: nome.value,
    cpf: cpf.value,
    telefone: telefone.value,
    endereco: endereco.value,
    itens,
    valor_total: valorLiquido,
    entrada: Number(entrada.value),
    parcelas: parcelasQtd,
    vencimento: dia,
    forma_pagamento: forma.value,
    status: valorLiquido === 0 ? 'pago' : 'pendente',
    parcelamento: parcelasArray
  };

  fetch(WEBHOOK_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  })
  .then(()=>alert('Venda enviada com sucesso!'))
  .catch(e=>alert('Erro: '+e));
}

let logoBase64 = "";

function carregarLogoBase64(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = function () {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      logoBase64 = canvas.toDataURL("image/jpeg");
      resolve();
    };
    img.src = url;
  });
}

// carrega sua logo ao abrir a p√°gina
carregarLogoBase64("https://i.postimg.cc/15q9V4g3/590410744-17857518639567477-1261351053422766599-n.jpg");

function gerarPDF(){
  const resumo = document.getElementById('resumoPrint');
  resumo.innerHTML = '';
  resumo.style.display = 'block';

  let itensHTML = '';
  document.querySelectorAll('#lista tr').forEach(tr=>{
    const t = tr.querySelectorAll('td');
    itensHTML += `<p>${t[1].innerText}x ${t[0].innerText} - ${t[3].innerText}</p>`;
  });

  resumo.innerHTML = `
    <div style="text-align:center;">
<img 
 <img src="${logoBase64}" style="max-height:90px">
  style="max-height:90px"
  crossorigin="anonymous"
/>
      <h2>Comprovante de Venda</h2>
    </div>
    <p><b>Cliente:</b> ${nome.value}</p>
    <p><b>CPF:</b> ${cpf.value}</p>
    <p><b>Telefone:</b> ${telefone.value}</p>
    <p><b>Endere√ßo:</b> ${endereco.value}</p>
    <hr>
    ${itensHTML}
    <hr>
    <p><b>Entrada:</b> R$ ${entrada.value}</p>
    <p><b>Parcelas:</b> ${parcelas.value}</p>
    <p><b>Vencimento:</b> Dia ${vencimento.value}</p>
    <p><b>Forma:</b> ${forma.value}</p>
    <h3>Total Final: R$ ${valorTotal.innerText}</h3>
  `;

 setTimeout(() => {
  html2pdf()
    .set({
      margin: 10,
      filename: 'comprovante-venda.pdf',
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    })
    .from(resumo)
    .save();
}, 200);
}
</script>

</body>
</html>
